// Cron job for postgres vacuum and replication
//
//  Setup in Jenkins:
//  > Folder > New Item > Pipeline
//  > Pipeline > Definition > Pipeline script from SCM
//    SCM: Git
//      Repository URL: https://github.com/bcgov/gwells
//      Branches to build: */master
//      Script path: scripts/Jenkinsfiles/pg_replicate

properties(
    [
        pipelineTriggers(
            [
                cron( 'H 6 * * 1-6' )
            ]
        )
    ]
)
String PROJECT = 'moe-gwells-prod'
int WELL_CHECK = 100000
stage ( 'run' )
{
    node ( 'master' )
    {
        String POD_DB = sh(
            script:
                """
                    oc get pods -n "${PROJECT}" | grep -i "Running" | grep -Eo \
                        "gwells-pgsql-[[:alpha:]]+-[[:digit:]]+-[[:alnum:]]+"
                """,
            returnStdout:
                true
        ).trim()

        String POD_APP = sh(
            script:
                """
                    oc get pods -n "${PROJECT}" | grep -i "Running" | grep -Eo \
                        "gwells-(test|prod)-[[:digit:]]+-[[:alnum:]]+" | head -1
                """,
            returnStdout:
                true
        ).trim()

        String DC_APP = sh(
            script:
                """
                    oc get dc -n "${PROJECT}" | grep -Eo "gwells-(test|prod)" | head -1
                """,
            returnStdout:
                true
        ).trim()

        String STATUS = sh(
            script:
                """
                oc exec "${POD_DB}" -n "${PROJECT}" -- /bin/bash -c \
                    'psql -d gwells -c \
                        "SELECT 1 AS online FROM WELLS.WELLS_WELLS LIMIT 1;" | grep -o online'
                """,
            returnStdout:
                true
        ).trim()
        if ( STATUS == "online" ){
            echo POD_DB +" is online"
            sh """
                oc patch route "${DC_APP}" -n "${PROJECT}" -p \
                    '{ "spec": { "to": { "name": "proxy-caddy"}, "port": { "targetPort": "2015-tcp" }}}'

                oc scale dc "${DC_APP}" --timeout=5s --replicas=0 -n "${PROJECT}"
                oc exec "${POD_DB}" -n "${PROJECT}" -- /bin/bash -c \
                    'psql -d gwells << EOF
VACUUM FULL;
ALTER USER gwells SET log_statement to 'none';
alter user gwells set log_min_duration_statement to 10000;         
EOF
'
                oc exec "${POD_DB}" -n "${PROJECT}" -- /bin/bash -c \
                    'psql -t -d gwells -U "\${POSTGRESQL_USER}" -c \
                        "SELECT db_replicate_step1(_subset_ind=>false);"'
                oc exec "${POD_DB}" -n "${PROJECT}" -- /bin/bash -c \
                    'psql -t -d gwells -U "\${POSTGRESQL_USER}" -c \
                        "SELECT db_replicate_step2 ();"'
                oc exec "${POD_DB}" -n "${PROJECT}" -- /bin/bash -c \
                    'psql -d gwells << EOF
VACUUM FULL;
ALTER USER gwells SET log_statement to 'all';
alter user gwells set log_min_duration_statement to -1;         
EOF
'
            """
        } else {
            echo POD_DB +" is offline"
        }
        int WELL_COUNT = sh(
            script:
                """
                    oc exec "${POD_DB}" -n "${PROJECT}" -- /bin/bash -c \
                        'psql -t -d gwells -U "\${POSTGRESQL_USER}" -c "SELECT count(*) from well;"'
                """,
            returnStdout:
                true
        ).trim()
        if ( WELL_COUNT > WELL_CHECK ){
            sh """
                oc scale dc "${DC_APP}" --timeout=5s --replicas=1 -n "${PROJECT}"
                sleep 20
                oc patch route "${DC_APP}" -n "${PROJECT}" -p \
                    '{ "spec": { "to": { "name": "${DC_APP}" }, "port": { "targetPort": "web" }}}'
            """
        } else {
            echo WELL_COUNT +" <= 120000, well count too low"
        }
    }
}

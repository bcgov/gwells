stage('API Test') {
    node('nodejs') {
		//the checkout is mandatory, otherwise functional test would fail
        echo "checking out source"
        echo "Build: ${BUILD_ID}"
        checkout scm
        dir('api-tests') {
	    try {
                sh 'npm install -g newman'
		sh './runnewman.sh'
	    } finally {
                junit 'newman/*.xml'
                stash includes: 'newman/*.xml', name: 'api-tests' 
                publishHTML (target: [
                            allowMissing: false,
                            alwaysLinkToLastBuild: false,
                            keepAll: true,
                            reportDir: 'newman',
                            reportFiles: 'newman*.html',
                            reportName: "API Test Report"
                        ])
                // Once included in the main developer pipeline, the next line will need to be omitted.
                perfReport compareBuildPrevious: true, excludeResponseTime: true, ignoreFailedBuilds: true, ignoreUnstableBuilds: true, modeEvaluation: true, modePerformancePerTestCase: true, percentiles: '0,50,90,100', relativeFailedThresholdNegative: 80.0, relativeFailedThresholdPositive: 20.0, relativeUnstableThresholdNegative: 50.0, relativeUnstableThresholdPositive: 50.0, sourceDataFiles: 'newman/*.xml'        
	            }
        }
    }
}

node('nodejs') {

	stage('API Test') {
		//the checkout is mandatory, otherwise functional test would fail
        echo "checking out source"
        echo "Build: ${BUILD_ID}"
        checkout scm
        dir('api-tests') {
	    try {
                sh 'npm install -g newman'
                sh 'newman run apitest.json -r cli,junit,html;'
                sh 'cd newman'
                sh 'mv *.html index.html'
                sh 'cd ..'
	    } finally {
                junit 'newman/*.xml'
                publishHTML (target: [
                            allowMissing: false,
                            alwaysLinkToLastBuild: false,
                            keepAll: true,
                            reportDir: 'newman',
                            reportFiles: 'index.html',
                            reportName: "API Test Report"
                        ])
	    }
        }
    }
}
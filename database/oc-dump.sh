#!/bin/sh
#
# Dumps from a GWells database and stores locally.  Project namespace required.
#
# Based on TFRS' process:
#	https://github.com/bcgov/gwells/tree/developer/database/xfer-registries-to-openshift
#
# NOTE: You need to be logged in with a token, via:
#       https://console.pathfinder.gov.bc.ca:8443/oauth/token/request


# Halt conditions, verbosity and field separator
#
set -euo pipefail
[ "${VERBOSE:-x}" != true ]|| set -x
IFS=$'\n\t'


# Parameters
#
PROJECT=${1:-}
SAVE_TO=${2:-$(date +%Y-%m-%d-%T.out)}


# Mode variables
#
MAINTENANCE=${MAINTENANCE:-true}


# Show message if passed any params
#
if [ "${#}" -eq 0 ]
then
	echo
    echo "Dumps from a GWells database to store locally"
    echo
	echo "Provide a project name."
	echo " './oc-dump.sh <project_name> <optional:output_file>'"
	echo
	exit
fi


# Check login
#
if ( ! oc whoami )
then
    echo
    echo "Please obtain an OpenShift API token.  A window will open shortly."
    sleep 3
    open https://console.pathfinder.gov.bc.ca:8443/oauth/token/request
    exit
fi


# Check project availability
#
CHECK=$( oc projects | tr -d '*' | grep -v "Using project" | grep "${PROJECT}" | awk '{ print $1 }' || echo )
if [ "${PROJECT}" != "${CHECK}" ]
then
	echo
	echo "Unable to access project ${PROJECT}"
	echo
	exit
fi


# Put GWells into maintenance mode
#
REPO_DIR=$( git rev-parse --show-toplevel )
[ "${MAINTENANCE}" != "true" ] || echo $(
	cd ${REPO_DIR}/maintenance/;
	./maintenance.sh ${PROJECT} off;
)

#!/bin/bash -x
# Add -x beside  #!/bin/bash to debug. It will print out the executed commands.
#
# PRECONDITIONS: DATABASE_USER exists
eval wellsdump=${BACKUP_LOCATION}

psql --dbname postgresql://${LEGACY_DATABASE_USER}:${LEGACY_DATABASE_USER_PASSWORD}@127.0.0.1:5432/postgres <<EOF

DROP DATABASE IF EXISTS ${LEGACY_DATABASE_NAME};
CREATE DATABASE ${LEGACY_DATABASE_NAME} WITH OWNER ${LEGACY_DATABASE_USER};

\c ${LEGACY_DATABASE_NAME}

REVOKE ALL ON SCHEMA public FROM ${LEGACY_DATABASE_USER};
GRANT ALL ON SCHEMA public TO ${LEGACY_DATABASE_USER};
EOF

pg_restore --dbname postgresql://${LEGACY_DATABASE_USER}:${LEGACY_DATABASE_USER_PASSWORD}@127.0.0.1:5432/${LEGACY_DATABASE_NAME} --no-owner --no-privileges $wellsdump

/*
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/
<template>
  <div>
    <div class="card w-100">
      <div class="card-body">
        <h5 class="card-title">Classification &amp; Qualifications
          <button type="button" class="close pull-right" aria-label="Close" v-on:click="$emit('close')">
            <span aria-hidden="true">&times;</span>
          </button>
        </h5>
        <p v-if="loading" class="card-text">
          <b-row>
            <b-col md="12">
              <div class="fa-2x text-center">
                <i class="fa fa-circle-o-notch fa-spin"></i>
              </div>
            </b-col>
          </b-row>
        </p>
        <p v-else class="card-text">
          <b-row>
            <b-col class="font-weight-bold">Certification</b-col>
          </b-row>
          <b-row>
            <b-col md="6">
              <b-form-group label="Issued by" horizontal :label-cols="3">
                <b-form-select :options="formOptions.issuer" v-model="qualificationForm.primary_certificate.acc_cert_guid" required></b-form-select>
              </b-form-group>
            </b-col>
            <b-col md="6">
              <b-form-group label="Certificate number" horizontal :label-cols="3">
                <b-form-input type="text" placeholder="Enter certificate number" v-model="qualificationForm.primary_certificate_no" required></b-form-input>
              </b-form-group>
            </b-col>
          </b-row>
          <b-row>
            <b-col md="12">
              <b-form-group label="Select classification" horizontal :label-cols="2" class="font-weight-bold">
                <b-form-radio-group class="fixed-width font-weight-normal pt-2" :options="formOptions.classifications" @change="changedClassification" v-model="qualificationForm.subactivity.registries_subactivity_code" required></b-form-radio-group>
              </b-form-group>
            </b-col>
          </b-row>
          <b-row>
            <b-col md="8">
              <b-form-group label="Qualified to drill" class="font-weight-bold">
                <b-form-checkbox-group class="fixed-width font-weight-normal" :options="formOptions.qualifications" v-model="qualificationForm.qualifications" disabled>
                </b-form-checkbox-group>
              </b-form-group>
            </b-col>
          </b-row>
          <b-row>
            <b-col md="8">
              <h5>Adjudication</h5>
            </b-col>
          </b-row>
          <b-row>
            <b-col>
              <b-form-group horizontal :label-cols="5" label="Confirmed applicant is 19 years of age or older by reviewing" class="font-weight-bold">
                <b-form-select :options="formOptions.proofOfAge" v-model="qualificationForm.proof_of_age" required></b-form-select>
              </b-form-group>
            </b-col>
          </b-row>
          <b-row>
            <b-col>
              <b-form-group horizontal :label-cols="2" label="Date application received" class="font-weight-bold">
                <datepicker format="yyyy-MM-dd" v-model="qualificationForm.status_set[0].effective_date" required></datepicker>
              </b-form-group>
            </b-col>
          </b-row>
          <slot></slot>
        </p>
      </div>
    </div>
  </div>
</template>

<script>
import Datepicker from 'vuejs-datepicker'
import { mapGetters, mapActions } from 'vuex'
import { FETCH_DRILLER_OPTIONS } from '@/registry/store/actions.types'
export default {
  components: {
    Datepicker
  },
  props: ['value', 'activity'],
  data () {
    // We need a default data structure when we're creating an application. If we're editing an
    // application, we can piggy back off the value being passed in.
    const defaultData = {
      subactivity: {
        registries_subactivity_code: null
      },
      primary_certificate_no: null,
      primary_certificate: {
        acc_cert_guid: null
      },
      status_set: [
        {
          effective_date: null,
          status: 'P'
        }
      ],
      qualifications: []
    }
    return {
      qualificationForm: {...JSON.parse(JSON.stringify(defaultData)), ...this.value}
    }
  },
  watch: {
    // Watching the entire object is expensive, but we need some way of notifying the parent.
    computedQualificationForm: {
      handler: function (val, oldVal) {
        this.$emit('input', val)
      },
      deep: true
    }
  },
  methods: {
    changedClassification (value) {
      const match = this.subactivityMap.filter(item => item.registries_subactivity_code === value)[0]
      this.qualificationForm.qualifications = match.qualification_set.map(item => item.well_class)
    },
    ...mapActions([
      FETCH_DRILLER_OPTIONS
    ])
  },
  computed: {
    computedQualificationForm: function () {
      // We need to transform the bound dates to something that is acceptable to the API without affecting
      // the values to which the form are bound.
      // Make a deep copy, and transform the date fields.
      const transformed = JSON.parse(JSON.stringify(this.qualificationForm))
      transformed.status_set.forEach((status) => { status.effective_date = status.effective_date && status.effective_date.length >= 10 ? status.effective_date.substring(0, 10) : status.effective_date })
      return transformed
    },
    ...mapGetters([
      'loading',
      'drillerOptions'
    ]),
    formOptions () {
      let result = {
        issuer: [{value: null, text: 'Please select an option'}],
        classifications: [],
        qualifications: [],
        proofOfAge: [{value: null, text: 'Please select an option'}]
      }
      if (this.drillerOptions) {
        // If driller options have loaded, prepare the form options.
        result.proofOfAge = result.proofOfAge.concat(this.drillerOptions.ProofOfAgeCode.map((item) => { return {'text': item.description, 'value': item.registries_proof_of_age_code} }))
        if (this.activity in this.drillerOptions) {
          // Different activities have different options.
          result.classifications = this.drillerOptions[this.activity].SubactivityCode.map((item) => { return {'text': item.description, 'value': item.registries_subactivity_code} })
          result.qualifications = this.drillerOptions[this.activity].WellClassCode.map((item) => { return {'text': item.description, 'value': item.registries_well_class_code} })
          result.issuer = result.issuer.concat(this.drillerOptions[this.activity].AccreditedCertificateCode.map((item) => { return {'text': item.name + ' (' + item.cert_auth + ')', 'value': item.acc_cert_guid} }))
        }
      }
      return result
    },
    subactivityMap () {
      return this.activity in this.drillerOptions ? this.drillerOptions[this.activity].SubactivityCode : []
    }
  },
  created () {
    this.FETCH_DRILLER_OPTIONS()
  }
}
</script>

<style>
.vdp-datepicker input {
  width: 80px;
}
.fixed-width .custom-control-label {
  width: 220px;
}
</style>
